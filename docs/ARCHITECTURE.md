# OpenVibe æ¶æ„è®¾è®¡

## 1. ç³»ç»Ÿæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           OpenVibe System                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Mobile     â”‚      â”‚    Cloud     â”‚      â”‚    Dev Server        â”‚  â”‚
â”‚  â”‚   App        â”‚â—€â”€â”€â”€â”€â–¶â”‚    Hub       â”‚â—€â”€â”€â”€â”€â–¶â”‚    (Arch Linux)      â”‚  â”‚
â”‚  â”‚              â”‚      â”‚              â”‚      â”‚                      â”‚  â”‚
â”‚  â”‚  - Next.js   â”‚      â”‚  - Go        â”‚      â”‚  - opencode serve    â”‚  â”‚
â”‚  â”‚  - Capacitor â”‚      â”‚  - WebSocket â”‚      â”‚  - HTTP API :4096    â”‚  â”‚
â”‚  â”‚  - iOS/Droid â”‚      â”‚  - Auth      â”‚      â”‚  - SSE streaming     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                        â”‚                â”‚
â”‚    Capacitor             Port 8080               Port 4096             â”‚
â”‚    Native Shell          Public IP              localhost              â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. ç»„ä»¶èŒè´£

### 2.1 Mobile App (`/app`)

**æŠ€æœ¯æ ˆ**: Next.js 14 + TypeScript + TailwindCSS + Capacitor

**èŒè´£**:
- ç”¨æˆ·ç•Œé¢æ¸²æŸ“ï¼ˆèŠå¤©ç•Œé¢ï¼‰
- WebSocket è¿æ¥ç®¡ç†
- æ¶ˆæ¯å‘é€/æ¥æ”¶
- ä¼šè¯å†å²æœ¬åœ°å­˜å‚¨
- æ–­çº¿é‡è¿é€»è¾‘

**å…³é”®æ¨¡å—**:
```
app/src/
â”œâ”€â”€ components/          # UI ç»„ä»¶
â”‚   â”œâ”€â”€ ChatView.tsx     # èŠå¤©ä¸»ç•Œé¢
â”‚   â”œâ”€â”€ MessageBubble.tsx # æ¶ˆæ¯æ°”æ³¡
â”‚   â”œâ”€â”€ InputBar.tsx     # è¾“å…¥æ 
â”‚   â””â”€â”€ SessionList.tsx  # ä¼šè¯åˆ—è¡¨
â”œâ”€â”€ hooks/               # React Hooks
â”‚   â”œâ”€â”€ useWebSocket.ts  # WebSocket ç®¡ç†
â”‚   â”œâ”€â”€ useSession.ts    # ä¼šè¯çŠ¶æ€
â”‚   â””â”€â”€ useMessages.ts   # æ¶ˆæ¯ç®¡ç†
â”œâ”€â”€ lib/                 # å·¥å…·åº“
â”‚   â”œâ”€â”€ ws-client.ts     # WebSocket å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ storage.ts       # æœ¬åœ°å­˜å‚¨
â”‚   â””â”€â”€ api.ts           # API ç±»å‹å®šä¹‰
â””â”€â”€ app/                 # Next.js è·¯ç”±
    â”œâ”€â”€ page.tsx         # ä¸»é¡µé¢
    â””â”€â”€ layout.tsx       # å¸ƒå±€
```

### 2.2 Cloud Hub (`/hub`)

**æŠ€æœ¯æ ˆ**: Go 1.22 + gorilla/websocket

**èŒè´£**:
- æ¥æ”¶ App çš„ WebSocket è¿æ¥
- Token è®¤è¯
- è½¬å‘è¯·æ±‚åˆ° OpenCode API
- å°† SSE å“åº”è½¬æ¢ä¸º WebSocket æ¶ˆæ¯
- è¿æ¥æ± ç®¡ç†

**å…³é”®æ¨¡å—**:
```
hub/
â”œâ”€â”€ cmd/hub/
â”‚   â””â”€â”€ main.go          # å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ server.go    # WebSocket æœåŠ¡å™¨
â”‚   â”œâ”€â”€ proxy/
â”‚   â”‚   â””â”€â”€ proxy.go     # OpenCode API ä»£ç†
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ auth.go      # Token è®¤è¯
â”‚   â””â”€â”€ config/
â”‚       â””â”€â”€ config.go    # é…ç½®ç®¡ç†
â””â”€â”€ go.mod
```

### 2.3 Dev Server (OpenCode)

**æŠ€æœ¯**: å®˜æ–¹ `opencode serve` å‘½ä»¤

**èŒè´£**:
- è¿è¡Œ AI Agent
- æä¾› HTTP API
- SSE äº‹ä»¶æµ
- ä¼šè¯ç®¡ç†

**API ç«¯ç‚¹** (ç”± OpenCode æä¾›):
| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|------|------|------|
| `/session` | GET | åˆ—å‡ºä¼šè¯ |
| `/session` | POST | åˆ›å»ºä¼šè¯ |
| `/session/:id/message` | POST | å‘é€æ¶ˆæ¯ |
| `/session/:id/message` | GET | è·å–æ¶ˆæ¯å†å² |
| `/event` | GET | SSE äº‹ä»¶è®¢é˜… |

## 3. é€šä¿¡åè®®

### 3.1 App â†” Hub (WebSocket)

**è¿æ¥**: `ws://hub-ip:8080/ws?token=xxx`

**æ¶ˆæ¯æ ¼å¼**:
```typescript
// Client â†’ Server
interface ClientMessage {
  type: 'prompt' | 'session.create' | 'session.list' | 'ping';
  payload: {
    sessionId?: string;
    content?: string;
    model?: { providerId: string; modelId: string };
  };
  id: string; // ç”¨äºåŒ¹é…å“åº”
}

// Server â†’ Client
interface ServerMessage {
  type: 'response' | 'stream' | 'error' | 'pong' | 'event';
  payload: any;
  id?: string; // å¯¹åº”è¯·æ±‚ ID
}
```

### 3.2 Hub â†” OpenCode (HTTP + SSE)

**è¯·æ±‚**: æ ‡å‡† HTTP POST/GET

**å“åº”**: SSE æµå¼è¾“å‡º

```
Hub æ”¶åˆ° App æ¶ˆæ¯
    â†“
POST /session/:id/message
    â†“
OpenCode è¿”å› SSE æµ
    â†“
Hub é€æ¡è½¬å‘ç»™ App (WebSocket)
```

## 4. è®¤è¯æœºåˆ¶ (MVP é˜¶æ®µ)

### 4.1 Token è®¤è¯

ç®€å•çš„é™æ€ Token è®¤è¯ï¼Œåç»­å¯å‡çº§ã€‚

```
1. æœåŠ¡å™¨ç”Ÿæˆ Token (é¦–æ¬¡è¿è¡Œæ—¶)
2. ç”¨æˆ·åœ¨ App ä¸­è¾“å…¥ Token
3. App è¿æ¥æ—¶æºå¸¦ Token
4. Hub éªŒè¯ Token
```

**Token å­˜å‚¨**:
- Hub: ç¯å¢ƒå˜é‡ `OPENVIBE_TOKEN`
- App: æœ¬åœ°å­˜å‚¨ (SecureStorage)

### 4.2 TLS (å¯é€‰)

å¦‚æœæœ‰åŸŸåï¼Œä½¿ç”¨ Let's Encrypt é…ç½® HTTPSã€‚
MVP é˜¶æ®µå…ˆç”¨ HTTPã€‚

## 5. æ•°æ®æµ

### 5.1 å‘é€æ¶ˆæ¯

```
User Input
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  WebSocket   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   HTTP POST   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   App   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Hub   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  OpenCode   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ¥æ”¶å›å¤ (æµå¼)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   SSE Stream   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  WebSocket  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenCode   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Hub   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   App   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                              â”‚                       â”‚
    â”‚  event: message.part         â”‚  {type: "stream"}     â”‚
    â”‚  data: {"content": "Hello"}  â”‚                       â”‚
    â”‚                              â”‚                       â”‚
    â”‚  event: message.part         â”‚  {type: "stream"}     â”‚
    â”‚  data: {"content": " World"} â”‚                       â”‚
```

## 6. é”™è¯¯å¤„ç†

### 6.1 è¿æ¥é”™è¯¯

| åœºæ™¯ | App è¡Œä¸º |
|------|----------|
| Hub ä¸å¯è¾¾ | æ˜¾ç¤ºé”™è¯¯ï¼Œ3ç§’åé‡è¯• |
| Token æ— æ•ˆ | æç¤ºé‡æ–°è¾“å…¥ Token |
| OpenCode ç¦»çº¿ | Hub è¿”å› 503ï¼ŒApp æ˜¾ç¤ºæœåŠ¡ä¸å¯ç”¨ |

### 6.2 é‡è¿ç­–ç•¥

```typescript
const RECONNECT_DELAYS = [1000, 2000, 5000, 10000, 30000];
// æŒ‡æ•°é€€é¿ï¼Œæœ€å¤§ 30 ç§’
```

## 7. éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åä¸ºäº‘ (121.36.218.61)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Hub (Go Binary)                                 â”‚   â”‚
â”‚  â”‚  - ç›‘å¬ 0.0.0.0:8080                            â”‚   â”‚
â”‚  â”‚  - systemd ç®¡ç†                                  â”‚   â”‚
â”‚  â”‚  - æ—¥å¿—: /var/log/openvibe/hub.log             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                               â”‚
â”‚                         â”‚ HTTP (å†…ç½‘ç©¿é€/SSHéš§é“)       â”‚
â”‚                         â–¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ SSH Tunnel (localhost:4096)
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Arch æœåŠ¡å™¨                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  opencode serve                                  â”‚   â”‚
â”‚  â”‚  - ç›‘å¬ 127.0.0.1:4096                          â”‚   â”‚
â”‚  â”‚  - systemd ç®¡ç†                                  â”‚   â”‚
â”‚  â”‚  - å·¥ä½œç›®å½•: /home/zcy/workspace                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.1 SSH éš§é“ (Arch â†’ åä¸ºäº‘)

```bash
# åœ¨ Arch æœåŠ¡å™¨ä¸Šå»ºç«‹åå‘éš§é“
ssh -R 4096:localhost:4096 huawei -N
```

è¿™æ · Hub å¯ä»¥é€šè¿‡ `localhost:4096` è®¿é—® OpenCodeã€‚

## 8. æœªæ¥æ‰©å±•ç‚¹

### 8.1 Docker åŒ– (Phase 2.5) ğŸš€ **ä¼˜å…ˆçº§: é«˜**

å°† OpenCode å®ä¾‹ä» tmux è¿›ç¨‹è¿ç§»åˆ° Docker å®¹å™¨ï¼š

```
å½“å‰:
Agent â†’ tmux session â†’ opencode serve (host)

ç›®æ ‡:
Agent â†’ Docker container â†’ opencode serve (isolated)
         â””â”€â”€ æ–°é¡¹ç›®: named volume
         â””â”€â”€ å·²æœ‰é¡¹ç›®: bind mount
```

**ä¼˜åŠ¿**:
- å®Œå…¨éš”ç¦»çš„è¿è¡Œç¯å¢ƒ
- å®¹å™¨çº§å®‰å…¨æ€§ (namespace, cgroups)
- å¯é…ç½®èµ„æºé™åˆ¶ (CPU/Memory)
- ä¸€é”®æ¸…ç†ï¼Œæ— æ®‹ç•™

è¯¦è§: [MULTI_PROJECT.md](./MULTI_PROJECT.md#7-docker-integration-)

### 8.2 E2EE (Phase 3)
- å¢åŠ  Go Agent åœ¨ Arch ç«¯
- X25519 å¯†é’¥äº¤æ¢
- AES-256-GCM åŠ å¯†
- Hub å˜æˆå®Œå…¨ç›²è½¬

### 8.2 å¤š Host æ”¯æŒ
- ä¸€ä¸ª App è¿æ¥å¤šå°å¼€å‘æœº
- Hub ç»´æŠ¤ Host è·¯ç”±è¡¨

### 8.3 Macro Deck
- åŠ¨æ€æŒ‰é’®é…ç½®
- å¸¸ç”¨å‘½ä»¤å¿«æ·é”®

### 8.4 æ–‡ä»¶é¢„è§ˆ
- å›¾ç‰‡/PDF ä¼ è¾“
- Web åº”ç”¨éš§é“é¢„è§ˆ
